name: PitchBlack Recovery Project Builder
on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'PBRP Manifest Branch (é€‰æ‹©PBRPæºç åˆ†æ”¯)'
        required: true
        default: 'android-12.1'
        type: choice
        options:
        - android-14.0
        - android-12.1
        - android-11.0
        - android-10.0
        - android-9.0
        - android-8.1
        - android-7.1
        - android-6.0
      DEVICE_TREE:
        description: 'Custom Recovery Tree URL (è®¾å¤‡æ ‘GitHubä»“åº“åœ°å€)'
        required: true
        default: 'https://github.com/enter_username/repo_name'
      DEVICE_TREE_BRANCH:
        description: 'Device Tree Branch (è®¾å¤‡æ ‘åˆ†æ”¯ï¼Œå¯é€‰ï¼Œç•™ç©ºåˆ™ç”¨é»˜è®¤åˆ†æ”¯)'
        required: false
        default: ''
      BUILD_TARGET:
        description: 'Build Target (æ„å»ºç›®æ ‡ï¼šAndroid 11+æ¨èé€‰pbrp)'
        required: true
        default: 'recovery'
        type: choice
        options:
        - pbrp
        - recovery
        - boot
        - vendorboot
      LDCHECK_PATH:
        description: 'Path for dependency check (ä¾èµ–æ£€æŸ¥è·¯å¾„ï¼Œå¯é€‰)'
        required: false
        default: 'recovery/root/system/bin/qseecomd'
      upload_releases:
        description: 'Whether to upload to GitHub Releases (æ˜¯å¦ä¸Šä¼ åˆ°Release)'
        required: true
        default: 'false'
        type: boolean
      DEVICE_NAME:
        description: 'Device Name (è®¾å¤‡åç§°ï¼Œå¦‚lenovo_tb375fcï¼Œéœ€ä¸è®¾å¤‡æ ‘åŒ¹é…)'
        required: true
        default: 'your_device_name'

jobs:
  build:
    name: Build PBRP by ${{ github.actor }}
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id  # ä»…ä»“åº“æ‰€æœ‰è€…å¯è§¦å‘
    env:
      DEBIAN_FRONTEND: noninteractive  # ç¦ç”¨APTäº¤äº’æç¤º
    permissions:
      contents: write  # æˆäºˆå†™å…¥ä»“åº“å†…å®¹æƒé™ï¼ˆç”¨äºä¸Šä¼ Release/Artifactsï¼‰
      
    steps:
    # 1. åˆå§‹åŒ–æ„å»ºæ—¶é—´å˜é‡
    - name: Initial Setup
      run: |
        echo "BUILD_START=$(date +%s)" >> $GITHUB_ENV
        echo "BUILD_DATE=$(TZ=UTC date +%Y%m%d)" >> $GITHUB_ENV  # ç”¨UTCæ—¶é—´å‘½åï¼Œé¿å…æ—¶åŒºå·®å¼‚
        
    # 2. æ‹‰å–å·¥ä½œæµæ‰€åœ¨ä»“åº“ä»£ç 
    - name: Checkout Workflow Repo
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}
        fetch-depth: 1
        
    # 3. æ¸…ç†å·¥ä½œç©ºé—´ï¼ˆé‡Šæ”¾ç£ç›˜ç©ºé—´ï¼‰
    - name: Clean-up Unused Files
      uses: rokibhasansagar/slimhub_actions@main
      
    # 4. è®¾ç½®24GBäº¤æ¢ç©ºé—´ï¼ˆé¿å…æ„å»ºæ—¶å†…å­˜ä¸è¶³ï¼‰
    - name: Set Up 24GB Swap Space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 24
        
    # 5. ä¿®å¤Javaè¯ä¹¦ç¼ºå¤±é—®é¢˜ï¼ˆé¿å…HTTPSä¾èµ–ä¸‹è½½å¤±è´¥ï¼‰
    - name: Fix Java CACerts File Missing
      run: |
        # å®‰è£…è¯ä¹¦å·¥å…·å¹¶é‡å»ºJavaè¯ä¹¦ç¼“å­˜
        sudo apt-get update -y
        sudo apt-get install -y ca-certificates-java
        sudo update-ca-certificates --fresh
        # éªŒè¯è¯ä¹¦æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
        if [ -f "/etc/ssl/certs/java/cacerts" ]; then
          echo "âœ… Java cacerts file created successfully"
        else
          echo "âŒ Error: Java cacerts file still missing" && exit 1
        fi
        
    # 6. æ ¸å¿ƒæ­¥éª¤ï¼šæ„å»ºPBRP Recovery
    - name: Build PitchBlack Recovery
      uses: mlm-games/pitchblack-pbrp-builder-action@main
      id: build
      with:
        MANIFEST_BRANCH: ${{ inputs.MANIFEST_BRANCH }}
        DEVICE_TREE: ${{ inputs.DEVICE_TREE }}
        DEVICE_TREE_BRANCH: ${{ inputs.DEVICE_TREE_BRANCH }}
        BUILD_TARGET: ${{ inputs.BUILD_TARGET }}
      continue-on-error: false  # æ„å»ºå¤±è´¥æ—¶ç«‹å³ç»ˆæ­¢ï¼Œä¾¿äºå®šä½é—®é¢˜
        
    # 7. ä¸Šä¼ æ„å»ºäº§ç‰©åˆ°Artifactsï¼ˆä¸´æ—¶å­˜å‚¨ï¼Œç”¨äºæ‰‹åŠ¨ä¸‹è½½ï¼‰
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      if: ${{ inputs.upload_releases == 'false' || github.event_name != 'workflow_dispatch' }}
      with:
        name: PBRP-Recovery-${{ inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}
        path: |
          ${{ env.OUTPUT_DIR }}/*.img    # Recoveryé•œåƒæ–‡ä»¶
          ${{ env.OUTPUT_DIR }}/*.tar   # æ‰“åŒ…é•œåƒæ–‡ä»¶
          ${{ env.OUTPUT_DIR }}/*vbmeta* # vbmetaç›¸å…³æ–‡ä»¶ï¼ˆç”¨äºç¦ç”¨AVBéªŒè¯ï¼‰
          ${{ env.OUTPUT_DIR }}/*.cpio  # CPIOå½’æ¡£æ–‡ä»¶
        
    # 8. ä¸Šä¼ æ„å»ºäº§ç‰©åˆ°GitHub Releasesï¼ˆéœ€æ‰‹åŠ¨å¼€å¯upload_releasesï¼‰
    - name: Upload to GitHub Releases
      if: success() && inputs.upload_releases == 'true'
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.OUTPUT_DIR }}/*.img
          ${{ env.OUTPUT_DIR }}/PBRP*.zip  # PBRPåˆ·å…¥åŒ…
        name: PBRP for ${{ inputs.DEVICE_NAME }} - ${{ env.BUILD_DATE }}
        tag_name: PBRP-${{ inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}
        body: |
          ## ğŸ”¨ Build Information
          - **Build Date:** ${{ env.BUILD_DATE }} (UTC)
          - **PBRP Branch:** ${{ inputs.MANIFEST_BRANCH }}
          - **Device:** ${{ inputs.DEVICE_NAME }}
          - **Build Target:** ${{ inputs.BUILD_TARGET }}
          
          ## ğŸ“Œ Source Information
          - **Device Tree:** [${{ inputs.DEVICE_TREE }}](${{ inputs.DEVICE_TREE }}/tree/${{ inputs.DEVICE_TREE_BRANCH || 'main' }})
          - **Device Tree Branch:** ${{ inputs.DEVICE_TREE_BRANCH || 'Default Branch' }}
          
          ## âœ… Build Status
          - Recovery Image MD5: `${{ env.MD5_IMG }}`
          - ZIP Package MD5: `${{ env.MD5_ZIP }}`
          
          > âš ï¸ Note: This is an automated build. Test thoroughly before using on main device.
        prerelease: false  # æ ‡è®°ä¸ºæ­£å¼Releaseï¼ˆéé¢„å‘å¸ƒï¼‰
        draft: false       # ç›´æ¥å‘å¸ƒï¼ˆéè‰ç¨¿ï¼‰
        
    # 9. ä¾èµ–æ£€æŸ¥ï¼ˆå¯é€‰ï¼Œå³ä½¿å¤±è´¥ä¹Ÿä¸é˜»æ–­æµç¨‹ï¼‰
    - name: Run Dependency Check (LDCHECK)
      uses: mlm-games/ldcheck-action@main
      with:
        OUTPUT_DIR: ${{ env.OUTPUT_DIR }}
        LDCHECKPATH: ${{ inputs.LDCHECK_PATH }}
      continue-on-error: true
        
    # 10. è®¡ç®—æ„å»ºè€—æ—¶
    - name: Calculate Build Duration
      if: always()
      run: |
        BUILD_END=$(date +%s)
        BUILD_DURATION=$((BUILD_END - BUILD_START))
        
        hours=$((BUILD_DURATION / 3600))
        minutes=$(((BUILD_DURATION % 3600) / 60))
        seconds=$((BUILD_DURATION % 60))
        
        echo "ğŸ“Š Build completed in ${hours}h ${minutes}m ${seconds}s"
        # ä¿å­˜è€—æ—¶åˆ°ç¯å¢ƒå˜é‡ï¼ˆä¾¿äºåç»­æ‰©å±•ï¼‰
        echo "BUILD_DURATION=${BUILD_DURATION}" >> $GITHUB_ENV
        echo "BUILD_HOURS=${hours}" >> $GITHUB_ENV
        echo "BUILD_MINUTES=${minutes}" >> $GITHUB_ENV
        echo "BUILD_SECONDS=${seconds}" >> $GITHUB_ENV
        
    # 11. æ¸…ç†å·¥ä½œç©ºé—´ï¼ˆé‡Šæ”¾èµ„æºï¼‰
    - name: Cleanup Workspace
      if: always()
      run: |
        cd ${{ github.workspace }}
        rm -rf android-recovery  # åˆ é™¤æ„å»ºç”Ÿæˆçš„æºç ç›®å½•
        df -h  # æ˜¾ç¤ºç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µï¼ˆä¾¿äºè°ƒè¯•ï¼‰
